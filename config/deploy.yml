# Kamal 2 deployment configuration for Tehnoholod
# Docs: https://kamal-deploy.org

service: tehnoholod

image: efelikanfuzin/tehnoholod

servers:
  web:
    hosts:
      - 82.196.7.203
    options:
      memory: 512m
    volumes:
      - "tehnoholod_storage:/rails/storage"
      - "tehnoholod_db:/rails/db"
      - "tehnoholod_uploads:/rails/public/uploads"

proxy:
  ssl: true
  host: tehnoholod.ru
  app_port: 3000
  healthcheck_path: /up

registry:
  server: ghcr.io
  username: efelikanfuzin
  password:
    - KAMAL_REGISTRY_PASSWORD

builder:
  arch: amd64

env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: "1"
    RAILS_SERVE_STATIC_FILES: "1"
  secret:
    - RAILS_MASTER_KEY
    - SECRET_KEY_BASE
    - SMTP_PASSWORD

ssh:
  user: deploy

# Retain last 3 images for quick rollback
retain_containers: 3
